import { parse, parseISO } from "date-fns"
import { PostLayout } from "../../components/PostLayout"
import { ImageWrapper } from "../../components/atoms/ImageWrapper"
import { ReanimatedSample } from "../../components/pages/2022-08-08-reanimated-web-config/ReanimatedSample"
import { View, Text, ActivityIndicator } from "react-native"

export const meta = {
  title: "Webã§react-native-reanimatedã®è¨­å®šã‚’è¡Œã†ğŸ¨",
  tagNames: ["react-native-web", "next.js", "react-native-reanimated"],
  color1: "#233A9E",
  color2: "#239E71",
  createdAt: parse(
    "2022-08-08 12:40:00 +09:00",
    "yyyy-MM-dd HH:mm:ss XXX",
    new Date(),
  ),
  author: "@gaishimo",
  description:
    "React Native Webã§ã®react-native-reanimatedã®è¨­å®šãŒæ„å¤–ã¨å¤§å¤‰ã ã£ãŸãŸã‚ã€è¨˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚",
  lastUpdatedAt: parse(
    "2022-08-08 12:40:00 +09:00",
    "yyyy-MM-dd HH:mm:ss XXX",
    new Date(),
  ),
}

export const headlines = [
  { title: "åŸºæœ¬è¨­å®š" },
  { title: "Webå›ºæœ‰ã®è¨­å®š", children: [
    { title: "WebPack DefinePluginã®è¿½åŠ " },
    { title: "requestAnimationFrameã®polyfillã‚’è¿½åŠ " },
    { title: "reanimatedã®transpile" },
    { title: "babel moduleã®è¿½åŠ " },
    { title: "reanimate 2.9.1ã®ã‚¨ãƒ©ãƒ¼" },
    { title: "Module not foundã‚¨ãƒ©ãƒ¼" },
  ]},
]

export default props => (
  <PostLayout headlines={headlines} meta={meta}>
    {props.children}
  </PostLayout>
)


Next.js (React Native Web)ã§react-native-reanimatedã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®šãŒæ€ã„ã®å¤–å¤§å¤‰ã ã£ãŸã®ã§ã€è¨˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚


## åŸºæœ¬è¨­å®š

åŸºæœ¬çš„ãªè¨­å®šã«ã¤ã„ã¦ã¯[Reanimatedã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.swmansion.com/react-native-reanimated/docs/fundamentals/installation)ã‚’å‚è€ƒã«ã—ã¾ã™ã€‚


ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€
```bash
yarn add react-native-reanimated
```

babel.config.jsã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js
module.exports = {
    ...
    plugins: [
        ...
        'react-native-reanimated/plugin',
    ],
};
```

## Webå›ºæœ‰ã®è¨­å®š

Reanimatedã®[Webè¨­å®šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.swmansion.com/react-native-reanimated/docs/fundamentals/web-support) ã«Webpackã®è¨­å®šãŒè¼‰ã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã‚Œã‚’å‚è€ƒã«ã—ã¾ã™ã€‚


### WebPack DefinePluginã®è¿½åŠ 

next.config.jsã§Webpack Pluginã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js
const nextConfig = {
  webpack: config => {
    config.plugins = [
      ...config.plugins,
      new webpack.EnvironmentPlugin({ JEST_WORKER_ID: null }),
      new webpack.DefinePlugin({
        __DEV__: process.env.NODE_ENV === 'development',
      }),
    ]
    return config
  }
}
module.exports = nextConfig
```

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.swmansion.com/react-native-reanimated/docs/fundamentals/web-support)ã ã¨DefinePluginã®éƒ¨åˆ†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€Next.jsã®å ´åˆã€ã“ã‚Œã§ã¯envã®å€¤ãŒã‚¯ãƒªã‚¢ã•ã‚Œãªã„ãŸã‚ã€ `__DEV__`ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```js
new webpack.DefinePlugin({ process: { env: {} } })
```

### requestAnimationFrameã®polyfillã‚’è¿½åŠ 

ã¾ãŸ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.swmansion.com/react-native-reanimated/docs/fundamentals/web-support)ã§ã¯babel-polyfillã®è¨­å®šãŒã‚ã‚Šã¾ã™ãŒã“ã‚ŒãŒç„¡ã„ã¨ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§requestAnimationFrameãŒå‘¼ã³å‡ºã•ã‚ŒãŸæ™‚ã«undefinedã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯[Moti + Next.js](https://moti.fyi/next)ã‚’å‚è€ƒã«babel-polyfillã§ã¯ãªãã€`raf/polyfill`ã‚’ pages/_app.tsxã§importã—ã¾ã™ã€‚

```js
import "raf/polyfill"
```

### reanimatedã®transpile

next.jsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã®ã¾ã¾ã ã¨reanimatedãŒtranspileã•ã‚Œãšã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ãŸã‚[next-transpile-module](https://github.com/martpie/next-transpile-modules)ã‚’åˆ©ç”¨ã—ã¦transpileã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js
const withTM = require("next-transpile-modules")(["react-native-reanimated"])


module.exports = withTM(nextConfig)
```

### babel moduleã®è¿½åŠ 

ãã®ã¾ã¾reanimatedã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨babelã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç„¡ã„ã¨è¨€ã‚ã‚Œã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‚ã®ã‚’éƒ½åº¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

```bash
yarn add --dev @babel/plugin-transform-shorthand-properties @babel/plugin-transform-arrow-functions @babel/plugin-proposal-optional-chaining @babel/plugin-proposal-nullish-coalescing-operator @babel/plugin-transform-template-literals
```


### reanimate 2.9.1ã®ã‚¨ãƒ©ãƒ¼

reanimated 2.9.1ã§ã¯ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```js
./node_modules/react-native-reanimated/lib/reanimated2/layoutReanimation/animationBuilder/Keyframe.js
TypeError: Cannot read properties of undefined (reading 'params')
```

[ãƒã‚°ã®ã‚ˆã†ãªã®ã§](https://github.com/software-mansion/react-native-reanimated/issues/3027)ä»¥ä¸‹ã®ãƒ‘ãƒƒãƒã‚’é©ç”¨ã—ãŸã‚‰ç™ºç”Ÿã—ãªããªã‚Šã¾ã—ãŸã€‚


```diff
diff --git a/node_modules/react-native-reanimated/plugin.js b/node_modules/react-native-reanimated/plugin.js
--- a/node_modules/react-native-reanimated/plugin.js
+++ b/node_modules/react-native-reanimated/plugin.js
@@ -7,6 +7,7 @@
  * holds a map of function names as keys and array of argument indexes as values which should be automatically workletized(they have to be functions)(starting from 0)
  */
 const functionArgsToWorkletize = new Map([
+  ['useFrameCallback', [0]],
   ['useAnimatedStyle', [0]],
   ['useAnimatedProps', [0]],
   ['createAnimatedPropAdapter', [0]],
@@ -64,12 +65,15 @@
   'Map',
   'Set',
   '_log',
-  '_updateProps',
+  '_updatePropsPaper',
+  '_updatePropsFabric',
+  '_removeShadowNodeFromRegistry',
   'RegExp',
   'Error',
   'global',
   '_measure',
   '_scrollTo',
+  '_dispatchCommand',
   '_setGestureState',
   '_getCurrentTime',
   '_eventTimestamp',
@@ -305,13 +309,14 @@
     },
   });

+  const expression = fun.program.body.find(
+    ({ type }) => type === 'ExpressionStatement'
+  ).expression;
+
   const workletFunction = t.functionExpression(
     t.identifier(name),
-    fun.program.body[0].expression.params,
-    prependClosureVariablesIfNecessary(
-      closureVariables,
-      fun.program.body[0].expression.body
-    )
+    expression.params,
+    prependClosureVariablesIfNecessary(closureVariables, expression.body)
   );

   return generate(workletFunction, { compact: true }).code;
```

### Module not foundã‚¨ãƒ©ãƒ¼

ä»Šåº¦ã¯æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚

```txt
error - ./node_modules/react-native-reanimated/lib/reanimated2/platform-specific/RNRenderer.js:3:0
Module not found: Can't resolve 'react-native/Libraries/Renderer/shims/ReactNative'

Import trace for requested module:
./node_modules/react-native-reanimated/lib/createAnimatedComponent.js
./node_modules/react-native-reanimated/lib/Animated.js
./node_modules/react-native-reanimated/lib/index.js
./components/Sample.tsx
./pages/index.tsx
```

Webpackã®è¨­å®šã§ä»¥ä¸‹ã‚’è¿½åŠ ã—ãŸã‚‰è§£æ±ºã—ã¾ã—ãŸã€‚

```js
  config.resolve.extensions = [
    ".web.js",
    ".web.ts",
    ".web.tsx",
    ...config.resolve.extensions,
  ]
```

## reanimatedã‚’å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã‚‹

ã‚„ã£ã¨ã‚¨ãƒ©ãƒ¼ãŒã§ãªããªã£ãŸã®ã§ã€å®Ÿéš›ã«Reanimatedã®ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚


<View style={{ marginTop: 32 }}>
  <ReanimatedSample />
</View>

ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ¨ªã«ãƒ©ãƒ³ãƒ€ãƒ ã§Springã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

```tsx
import { useCallback } from "react"
import { Button, StyleSheet, View } from "react-native"
import Animated, {
  useAnimatedStyle,
  useSharedValue,
  withSpring,
} from "react-native-reanimated"

export function ReanimatedSample() {
  const offset = useSharedValue(0)

  const animatedStyles = useAnimatedStyle(() => {
    return {
      transform: [{ translateX: offset.value }],
    }
  }, [offset])

  return (
    <View>
      <Animated.View style={[styles.box, animatedStyles]} />
      <View style={styles.buttonWrapper}>
        <Button
          title="Move"
          onPress={useCallback(() => {
            console.log("onPress()")
            offset.value = withSpring(Math.random() * 255)
          }, [offset])}
        />
      </View>
    </View>
  )
}

const styles = StyleSheet.create({
  box: {
    width: 100,
    height: 100,
    borderRadius: 16,
    backgroundColor: "lightblue",
  },
  buttonWrapper: { marginTop: 24, width: 100 },
})
```

éƒ½åº¦ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§å¿ƒãŒæŠ˜ã‚Œãã†ã«ãªã‚Šã¾ã—ãŸãŒã€ãªã‚“ã¨ã‹å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

