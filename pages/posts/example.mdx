import { PostLayout } from "../../components/PostLayout"
import { PostHeader } from "../../components/PostHeader"

export const meta = {
  title: "Node.jsでLambdaを開発するならClaudia.jsがオススメ",
  tags: ["node.js", "lambda"],
  color1: "#00D5FF",
  color2: "#6BD63E",
  createdAt: new Date("2020-06-05"),
}

export const headlines = [
  { title: "Claudia.jsとは", children: [] },
  { title: "単独の Lambda Function を作成してみる",
    children: [
      { title: "コマンドラインツールをインストール", children: [] },
      { title: "Lambda プロジェクト作成", children: [] },
    ]
  },
]


export default (props) => <PostLayout>{props.children}</PostLayout>

<PostHeader 
  color1={"#00D5FF"}
  color2={"#6BD63E"}
  tagNames={meta.tags}
  title={meta.title}
  createdAt={meta.createdAt}
/>


この記事は[Serverless(2) Advent Calendar 2016](http://qiita.com/advent-calendar/2016/serverless2) の 16 日目の記事です。

自身のプロダクトを Claudia.js を使って開発しているのですが、今回はその紹介を書きたいと思います。

## Claudia.jsとは

[Claudia.js](https://claudiajs.com/)はオープンソースの Lambda デプロイメントツールです。Node.js で作成した Lambda アプリケーションを簡易にデプロイすることが出来ます。API Gateway と組み合わせることも可能です。

Lambda のデプロイツール(フレームワーク)といえば Serverless Framework や Apex など多数存在しますが、他のツールとくらべて Claudia.js は何が違うのでしょうか？

最も大きな特徴は、**Node.jsに特化している**という点です。Serverless や Apex のように複数のプログラミング言語に対応しているツールと異なり、Claudia.js は Node.js しかサポートしていません。その分、プログラミング言語に踏み込んだ機能が提供されているため、開発者は必要最小限のコードで開発を行うことができます。

作者の Gojko Adzic 氏はインタビューで以下のように話しています。

> 汎用的なフレームワークならばもっと多くのランタイムをサポートしますが，言語固有の部分への対処は開発者に任されています。それに，Lambda で JavaScript を実行させて気が付いたのですが，言語固有の問題というのは実にたくさんあるのです。

> Claudia は JavaScript/Node.js でのみ動作しますが，それに特化しています。Node.js に重点を置いているため，パラメータと結果を JavaScript で処理しやすいオブジェクトに変換するテンプレートが，自動的にインストールされます。JavaScript 開発者が希望する動作が，アウトオブボックスで可能になっているのです。例えば HTTP コード 200 で通知されるエラーは，Java では大きな問題ではありませんが，大部分の JavaScript Promise HTTP ライブラリの動作を損ないます。そのため Claudisa では，HTTP 500 を返送する API ゲートウェイを自動的にセットしています。

[Clauda.js で Node.js マイクロサービスを AWS Lambda にデプロイする - 作者 Gojko Adzic 氏との Q&A](https://www.infoq.com/jp/news/2016/06/microservices-lambda-claudiajs)

Claudia.js 自体はフレームワークではなく、シンプルなコマンドラインによるデプロイメントツールですが、[API Builder](https://claudiajs.com/claudia-api-builder.html)という拡張ライブラリを使うことにより、API Gateway と Lambda を組み合わせた Web API を簡易に作成することが可能になります。

では実際に使用して試してみたいと思います。

## 単独の Lambda Function を作成してみる

まずシンプルな Lambda Function のデプロイを試してみます。

### コマンドラインツールをインストール

```bash
$ npm install claudia -g
$ claudia --version
2.3.0
```

### Lambda プロジェクト作成

プロジェクトフォルダを作成し、以下のファイルを用意します。

```bash
mkdir simple-lambda
cd simple-lambda
```

```json
  "name": "simple-lambda",
  "version": "1.0.0",
  "description": "",
  "main": "lambda.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC"
```

```json
{
  "name": "Claudia"
}
```

```js
exports.handler = function (event, context) {
  console.log(event)
  context.succeed("hello " + event.name)
}
```

Lambda Function のコードは通常の Lambda Function を作成するときのコードと同じで、特に書き方は変わりません。

### Lambda Function のデプロイ

`claudia create` で Lambda Function の作成を行います。

```bash
$ claudia create --region ap-northeast-1 --handler lambda.handler
saving configuration
{
  "lambda": {
    "role": "simple-lambda-executor",
    "name": "simple-lambda",
    "region": "ap-northeast-1"
  }
}
```

### Lambda Function の実行

作成した Function は `claudia test-lambda` で実行できます。

```bash
$ claudia test-lambda --event event.json
{
  "StatusCode": 200,
  "Payload": "\"hello claudia!!\""
}
```

event.json で渡したパラメータを元に結果が返って来ているのがわかります。

### Lambda Function の更新

更新は、`claudia update`で行えます。試しに version をつけて更新してみます。

```bash
claudia update --version test-version

setting version alias	lambda.createAlias	FunctionName=simple-lambda	Name=test-version
{
  "FunctionName": "simple-lambda",
  "FunctionArn": "arn:aws:lambda:ap-northeast-1:588762728270:function:simple-lambda:4",
  "Runtime": "nodejs4.3",
  "Role": "arn:aws:iam::588762728270:role/simple-lambda-executor",
  "Handler": "lambda.handler",
  "CodeSize": 916,
  "Description": "",
  "Timeout": 3,
  "MemorySize": 128,
  "LastModified": "2016-12-16T01:56:46.710+0000",
  "CodeSha256": "BR8NbrwsKCTlkj+5BTR4TaygexFUXViOoYbd7xhEypU=",
  "Version": "4",
  "KMSKeyArn": null
}
```

### スケジュールイベントの設定

CloudWatch Event でスケジュールを元に定期的に実行する設定を行うことも可能です。
5 分おきに実行する設定を作成するには`claudia add-scheduled-event`を利用します。

```bash
$ claudia add-scheduled-event --event event.json \
  --name simple-lambda-scheduled-event \
  --schedule 'rate(5 minutes)' \
  --version test-version
```

スケジュールイベントの他に、S3 イベント、SNS イベントを元に起動するよう設定することも可能です(`claudia add-s3-event-source`, `claudia add-sns-event-source`)。

## API Builder により Web API を作成してみる

単独の Lambda Function をデプロイしただけでは Claudia.js のメリットがまださほど実感できません。今度は API Buidler を使って API Gateway と Lambda による Web API を作成してみたいと思います。

今回は DynamoDB を利用した CRUD アプリケーションを作成します。

### 事前テーブル作成

DynamoDB で以下のテーブルを作成しておきます。

```bash
$ aws dynamodb create-table --table-name wrestlers \
  --attribute-definitions AttributeName=id,AttributeType=N \
  --key-schema AttributeName=id,KeyType=HASH \
  --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 \
  --query TableDescription.TableArn --output text
```

プロレスラーを保存する`wrestlers`テーブルになります(この題材はどうなのかは置いといて)。

### API Project の作成

```bash
mkdir simple-api
cd simple-api
```

プロジェクトフォルダを作成し、必要なファイルを用意していきます。

```json
{
  "name": "simple-api",
  "version": "1.0.0",
  "description": "",
  "main": "app.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "aws-sdk": "^2.7.15",
    "claudia-api-builder": "^2.3.1"
  }
}
```

`claudia-api-builder`と DynamoDB を操作するための`aws-sdk`を dependencies に追加しています。

また Lambda から DynamoDB にアクセスするために、以下の IAM Policy 用の json ファイルを用意する必要があります。

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "dynamodb:GetItem",
        "dyanmodb:Scan",
        "dynamodb:Query",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem"
      ],
      "Effect": "Allow",
      "Resource": "*"
    }
  ]
}
```

アプリのコードは以下となります。Express 等で Web サーバを作るときと雰囲気が似ています。基本的な CRUD 操作を行う API です。ベースは [example-projects/dynamodb-example at master · claudiajs/example-projects](https://github.com/claudiajs/example-projects/tree/master/dynamodb-example) を参考にています。

```js
const ApiBuilder = require("claudia-api-builder")
const AWS = require("aws-sdk")
const dynamoDB = new AWS.DynamoDB.DocumentClient()
const api = new ApiBuilder()
const tableName = "wrestlers"
module.exports = api

api.post(
  "/wrestlers",
  function (request) {
    const params = {
      TableName: tableName,
      Item: {
        id: request.body.id,
        name: request.body.name,
        finishingMove: request.body.finishingMove,
      },
    }
    return dynamoDB.put(params).promise()
  },
  { success: 201 },
)

api.get("/wrestlers/{id}", function (request) {
  const id = parseInt(request.pathParams.id, 10)
  const params = {
    TableName: tableName,
    Key: { id: id },
  }
  return dynamoDB
    .get(params)
    .promise()
    .then(function (response) {
      return response.Item
    })
})

api.get("/wrestlers", function (request) {
  const params = {
    TableName: tableName,
  }
  return dynamoDB
    .scan(params)
    .promise()
    .then(function (response) {
      return response.Items
    })
})

api.patch("/wrestlers/{id}", function (request) {
  const id = parseInt(request.pathParams.id, 10)
  const params = {
    TableName: tableName,
    Key: { id: id },
    UpdateExpression: "SET #f1 = :v1, #f2 = :v2",
    ExpressionAttributeNames: {
      "#f1": "name",
      "#f2": "finishingMove",
    },
    ExpressionAttributeValues: {
      ":v1": request.body.name,
      ":v2": request.body.finishingMove,
    },
  }
  return dynamoDB.update(params).promise()
})

api.delete("/wrestlers/{id}", function (request) {
  const id = parseInt(request.pathParams.id, 10)
  const params = {
    TableName: tableName,
    Key: { id: id },
  }
  return dynamoDB
    .delete(params)
    .promise()
    .then(function (response) {
      return response.Item
    })
})
```

各リソースのメソッド内では最後に以下のようなコードになっていますが、

```js
return dynamoDB.update(params).promise()
```

DynamoDB の DocumentClient は`.promise()`により Promise オブジェクトを返すことができます。また、API Builder では Promise オブジェクトをそのまま戻り値にすることができます。

Get メソッドの場合は Promise のなかで`response.Item`を返していますが、こうするとそのオブジェクトの内容をレスポンスにすることができます。

```js
return dynamoDB
  .get(params)
  .promise()
  .then(function (response) {
    return response.Item
  })
```

### API のデプロイ

`claudia create`でデプロイを行います。
API Builder の場合は`--api-module`で対象のコードを指定します。また、DynamoDB を操作するための IAM ポリシーの JSON ファイルが置かれたディレクトリを`--policies`オプションで指定しています。

```bash
$ claudia create --region ap-northeast-1 --api-module app --policies policies
saving configuration
{
  "lambda": {
    "role": "simple-api-executor",
    "name": "simple-api",
    "region": "ap-northeast-1"
  },
  "api": {
    "id": "zpoqi40p34",
    "module": "app",
    "url": "https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest"
  }
}
```

### API のテスト

では API を実際にテストしてみます。

#### レコードの作成

```bash
$ curl -H "Content-Type: application/json" -X POST \
  --data '{ "id": 1, "name": "内藤哲也", "finishingMove": "Destino" }' \
  https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers
$ curl -H "Content-Type: application/json" -X POST \
  --data '{ "id": 2, "name": "棚橋弘至", "finishingMove": "ハイフライフロー" }' \
  https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers
$ curl -H "Content-Type: application/json" -X POST \
  --data '{ "id": 3, "name": "オカダカズチカ", "finishingMove": "レインメーカー" }' \
  https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers
```

#### レコードの取得

ID 指定での取得

```bash
$ curl -X GET https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers/1
{"name":"内藤哲也","id":1,"finishingMove":"Destino"}
```

一覧取得

```bash
$ curl -X GET https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers
[{"name":"オカダカズチカ","id":3,"finishingMove":"レインメーカー"},{"name":"棚橋弘至","id":2,"finishingMove":"ハイフライフロー"},{"name":"内藤哲也","id":1,"finishingMove":"Destino"}]
```

#### レコードの更新

```bash
$ # 更新
$ curl -H "Content-Type: application/json" -X PATCH \
  --data '{ "id": 1, "name": "内藤哲也", "finishingMove": "デスティーノ" }' \
  https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers/1
$ # 確認
$ curl -X GET https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers/1
{"name":"内藤哲也","id":1,"finishingMove":"デスティーノ"}
```

#### レコードの削除

```bash
curl -X DELETE https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers/3
```

### レスポンスのステータスコードを 404 にしてみる

今のままだと、Get でレコードがなかった場合も 200 が返ってきてしまいます。そこで、Get を以下のように変更します。

```js
api.get(
  "/wrestlers/{id}",
  function (request) {
    const id = parseInt(request.pathParams.id, 10)
    const params = {
      TableName: tableName,
      Key: { id: id },
    }
    return dynamoDB
      .get(params)
      .promise()
      .then(function (response) {
        if (!response.Item) {
          throw new Error("not found")
        }
        return response.Item
      })
  },
  { success: 200, error: 404 },
)
```

`.get()`メソッドの 3 つ目の引数に`{ success: 200, error: 404 }` を指定しています。処理中では、レコードが存在しなかったら例外を throw しています。

この状態でレコードが存在しないリソースを指定して API を実行すると、

```bash
$ curl -I -X GET https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers/999
HTTP/1.1 404 Not Found
Content-Type: application/json
Content-Length: 28
Connection: keep-alive
...
```

404 が返ってきます。

※内容に応じて 400, 404 といったようにステータスコードを動的に変えたい場合は、以下のサンプルのように `ApiBuilder.ApiResponse`オブジェクトを返せば行けそうです
https://github.com/claudiajs/example-projects/blob/master/web-api-custom-status-code/web.js

### IAM 認証を追加してみる

デフォルトでは特に認証はつきませんが、IAM 認証を設定することが可能です。
試しに delete 処理に IAM 認証を設定してみます。

```js
api.delete(
  "/wrestlers/{id}",
  function (request) {
    const id = parseInt(request.pathParams.id, 10)
    const params = {
      TableName: tableName,
      Key: { id: id },
    }
    return dynamoDB
      .delete(params)
      .promise()
      .then(function (response) {
        return response.Item
      })
  },
  { success: 200, error: 404, authorizationType: "AWS_IAM" },
)
```

２つ目の引数のオプションで`authorizationType: 'AWS_IAM' }`を指定しています。

試しにこの状態で Delete しようとすると、

```
$ curl -I -X DELETE https://spzc7xv95a.execute-api.ap-northeast-1.amazonaws.com/latest/wrestlers/3

HTTP/1.1 403 Forbidden
```

403 が返ってきます。

その他に独自の認証を設定することも可能です。
[claudia-api-builder/api.md at master · claudiajs/claudia-api-builder](https://github.com/claudiajs/claudia-api-builder/blob/master/docs/api.md#require-authorization)

### Interceptor を設定してみる

すべてのリクエストで共通に行いたい処理がある場合は、Interceptor を使うことで実現できます。

たとえば、毎回`request`オブジェクトの内容をログ出力したい場合は以下のようにします。

```
api.intercept((request) => {
  console.log(
    'context: ', request.context,
    ' pathParams:', request.pathParams,
    ' queryString:', request.queryString,
    ' body: ', request.body
  )
  return request
})
```

Interceptor ではリクエストパラメータをフィルタリング、変更したり、条件によって処理を次に渡さずにレスポンスを返してしまったりすることも可能です。

[claudia-api-builder/api.md at master · claudiajs/claudia-api-builder](https://github.com/claudiajs/claudia-api-builder/blob/master/docs/api.md#intercepting-requests)

## 終わりに

API を作成する際、個別に API Gateway の設定を手動で行うのはかなり大変で苦痛な作業です。リソースの作成、メソッドの作成、リクエストパラメータの変換、レスポンスの変換、ステータスコードの設定等、すべき作業が山ほどあります。

API Builder を使うとそれらの設定を個別に行う必要がなく、Node.js のコードから自動で設定してくれます。YAML にリソースパスを記載したりする必要もありません。これは Node.js に特化している大きなメリットだと思います。

Lambda の開発でプログラミング言語に Node.js を使用できる場合は、有力な選択肢となるツールの一つだと思います。
